{% extends "base.html" %}

{% block title %} CDD Domain Search Dashboard {% endblock %}

{% block page_title %} {% endblock %}

{% block infoheader %} CDD Domain Search Dashboard {% endblock %}

{% block page_description %}
{% endblock %}

{% block page_header %}
    <div style="overflow-x: hidden; text-align: center;">
        CDD Domain Search Dashboard
        <br>
        <p style="text-align: center;font-size: small"> Monitor your CDD Domain searches, {{ request.user }}!</p>

    </div>
{% endblock %}
{% block header %}
{% endblock %}
{% block content %}
    {% if query_task_dict.items|length > 0 %}
    <div class="dashboard_project_list_col" style="overflow-x: hidden">
        {% for query, status in query_task_dict.items %}
            {% if status.0 == 'NOTEXEC' %}
                {% if status.1 == 'not valid' %}
                    <div class="row">
                        <a class="btn btn-dark disabled"
                           href="{% url 'execute_cdd_domain_search' project_id=project_id remote_or_local=remote_or_local %}">{{ query }} <= 2 RBHs or <= 2
                            CDD hits</a>
                    </div>
                {% else %}
                    <div class="row">
                         <p> CDD search for: {{ query }} not executed.</p>
                    </div>
                {% endif %}
            {% elif status.0 == 'SUCCESS' %}
                <div class="row col-sm-2">
                    <a class="btn btn-info" id="cdd_success"
                       href="{% url 'cdd_domain_search_details' project_id=project_id query_id=query remote_or_local=remote_or_local %}">View Results
                        for: {{ query }}</a>
                </div>
            {% elif status.0 == 'PROGRESS' %}
                <div class="row">
                    <div class="col-sm-2">
                         <p> CDD search for: {{ query }}</p>
                    </div>
                    <div class="col-sm-2">
                        <button class="btn btn-success" disabled>
                            <span class="spinner-grow spinner-grow-sm"></span>
                            <p><span class="progress-{{ query }}"></span></p>
                        </button>
                    </div>
                </div>
            {% elif status.0 == 'FAILURE' %}
                <div class="col-sm-4">
                     <a class="btn btn-danger"
                       href="{% url 'delete_cdd_domain_search' project_id=project_id query_id=query remote_or_local=remote_or_local %}"> An ERROR occurred, delete CDD Search
                        for: {{ query }}</a>
                </div>
            {% endif %}
        <br>
        {% endfor %}
    </div>
    {% endif %}

    <div class="dashboard_project_list_col">
        <form method="post" action="{% url 'execute_cdd_domain_search' project_id=project_id remote_or_local=remote_or_local %}">
            {% csrf_token %}
            {{ rpsblast_settingsform.as_p }}
            <input type="submit" value="Submit" class="btn btn-dark">
        </form>
    </div>

    <div class="dashboard_project_list_col" >
        <h3 class="col_header"> Query Sequence Domain Table </h3>
        {{ html_results|safe }}
    </div>

{% endblock %}
{% block scripts %}
    <script>
        {% for query, status in query_task_dict.items %}
            {% if status.0 == 'PROGRESS' %}
                (function () {
                    var status = $('.progress-{{query}}'),
                        poll = function () {
                            jQuery.ajax({
                                url: "{% url 'get_cdd_task_status_ajax_call' project_id=project_id query_id=query  %}",
                                dataType: 'json',
                                type: 'get',
                                success: function (data) { // check if available

                                    if (data.data) { // get and check data value
                                        status.text(data.data.progress); // get and print data string
                                        console.log(data)
                                        if (data.data.progress == "SUCCESS") {
                                            status.text("DONE - refresh the page")
                                            clearInterval(pollInterval); // optional: stop poll function
                                        } else if (data.data.progress != "PROGRESS") {
                                            status.text(data.data.progress)
                                            clearInterval(pollInterval);
                                        }

                                    }
                                },
                                error: function () { // error logging
                                    status.text("error polling progress data")
                                }
                            });
                        },
                        pollInterval = setInterval(function () { // run function every 5000 ms
                            poll();
                        }, 5000);
                    poll(); // also run function on init
                })();
            {% endif %}
        {% endfor %}
    </script>
{% endblock %}