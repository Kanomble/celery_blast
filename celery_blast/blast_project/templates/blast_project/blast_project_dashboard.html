{% extends "base.html" %}

{% block title %} CATHI Dashboard {% endblock %}

{% block page_title %} {% endblock %}

{% block infoheader %} CATHI Dashboard {% endblock %}

{% block page_description %}
    You are logged in as: <strong>{{request.user}}</strong>.<br>
    Monitor and execute your current projects by entering the
    <a class="nav-link" href="{% url 'active_table_view' selected_table="reciprocal_blast_projects" %}">Reciprocal Projects</a> dashboard.
    Manage and view available local databases by entering the
    <a class="nav-link" href="{% url 'active_table_view' selected_table="databases" %}">Active Databases</a> dashboard.

    If you want to create a completely new project or upload custom proteomes for BLAST databases creation, take a look at the navigation bar
    on the left hand side of this dashboard.
    <br>
    <h2> Content of this Web-Tool </h2>
    <ul>
        <li> <a href="{% url 'project_creation' %}">  Reciprocal BLAST pipeline project creation </a></li>
        <li> <a href="{% url 'one_way_project_creation' %}"> One-way BLAST project creation </a></li>
        <li> BLAST Database creation</li>
        <ul>
            <li> <a href="{% url 'refseq_transactions_dashboard' %}"> based on remotely available NCBI-Databases </a></li>
            <li> <a href="{% url 'upload_genomes'  %}"> based on locally downloaded or uploaded protein fasta files </a></li>
        </ul>
        <li> <a href="{% url 'entrez_dashboard' %}"> Search target sequences with the EDirect tool </a></li>
        <li> <a href="{% url 'species_taxids' %}"> Create files with taxonomic nodes for limiting your BLAST databases by taxonomic information </a></li>
    </ul>
{% endblock %}

{% block header %}
{% endblock %}

{% block content %}
{% if domain_database.domain_database_loaded == False or domain_database.domain_database_download_task_result.status != "SUCCESS" %}
    {% if domain_database.domain_database_download_task_result %}

        {% if domain_database.domain_database_download_task_result.status == "PROGRESS" %}
            <div class="dashboard_project_list_col" id="cdd_download_progress" style="display: flex;
                                                                          flex-direction: column;
                                                                          align-items: center;
                                                                          justify-content: center;">
                <button class="btn btn-dark" disabled>
                    <span class="spinner-grow spinner-grow-sm"></span>
                    <p><span class="domain_database_download_progress"></span></p>
                </button>
            </div>
        {% elif domain_database.domain_database_download_task_result.status == "FAILURE" %}
            <div class="dashboard_project_list_col" id="cdd_download_failure"  style="display: flex;
                                                                          flex-direction: column;
                                                                          align-items: center;
                                                                          justify-content: center;">
                <form class="col"
                       action="{% url "delete_domain_database" %}"
                       method="POST">
                    {% csrf_token %}
                    <input type="submit" value="Download Failed: Delete Domain Database" class="btn btn-danger">
                </form>
            </div>
        {% elif domain_database.domain_database_loaded == False and domain_database.domain_database_download_task_result.status == "SUCCESS" %}
             <div class="dashboard_project_list_col" id="project_dashboard" style="display: flex;
                                                                          flex-direction: column;
                                                                          align-items: center;
                                                                          justify-content: center;">
                {% include "blast_project/form_download_domain_database.html" %}
            </div>
        {% endif %}
    {% else %}
        <div class="dashboard_project_list_col" id="project_dashboard"  style="display: flex;
                                                                          flex-direction: column;
                                                                          align-items: center;
                                                                          justify-content: center;">
            {% include "blast_project/form_download_domain_database.html" %}
        </div>
    {% endif %}
{% endif %}

    <div class="dashboard_project_list_col" style="overflow-x: hidden">
        <h3  class="col_header" style="text-align: center"> Welcome to CATHI the Comparative Analysis Tool for Homolog Identification  </h3>
        <p style="font-size: medium; text-align: center">
            Within this dashboard you can find short help sections for each analysis step CATHI provides.
            The help sections are written by using an example analysis with Extracellular-Polymeric-Substance (EPS) genes of the
            bacterial species Curvibacter sp. AEP1-3.
        </p>
        <div class="row justify-content-md-center" style="text-align: center">
            <div class="col-md">
                <button class="btn btn-dark" onclick="displayDivElement('overview')">1. Overview</button>

            </div>
            <div class="col-md">
                <button class="btn btn-dark">2. </button>
            </div>
            <div class="col-md">
                <button class="btn btn-dark">Sequence Search</button>
            </div>
            <div class="col-md">
                <button class="btn btn-dark">Sequence Search</button>
            </div>
        </div>
    </div>

    <div id="overview" class="dashboard_project_list_col" style="overflow-x: hidden;display: none;">
        <h3  class="col_header" style="text-align: center;text-size-adjust: auto;margin-bottom: 30px"> Overview Section - What can you do with CATHI?  </h3>
        <div class="row" style="text-align:center;justify-content: center;">
            <p style="font-size: large; text-align: left">
                CATHI can aid researchers in the identification of possible target sequences and to elucidate the
                evolutionary background of those query sequences by generating interactive result graphs and tables.
                <br>
                <br>
                Press the button to view an example interactive visualization. <button class="btn btn-dark" onclick="displayDivElement('bokeh_example')"> Plot Example</button>
                <br>
            </p>
        </div>
        <div class="row" style="text-align:center;justify-content: center;"  id="bokeh_example">
            {% include "blast_project/interactive_bokeh_plot_example.html" %}
            <p style="font-size: large; text-align: left">
                <br>
                You can filter the reciprocal best hits (RBHs) based on their taxonomic identity by clicking on the taxonomy
                field names of the right selection menus. In addition, you can select multiple query sequences, change the x- and y-axis
                attributes, download selected sequences or conduct a phylogenetic inference.
                <br>
            </p>
        </div>
    </div>

{% endblock %}
{% block scripts %}
<script>
    (function () {
        var status = $('.domain_database_download_progress'),
            poll = function () {
                jQuery.ajax({
                    url: "{% url 'domain_database_download_status' %}",
                    dataType: 'json',
                    type: 'get',
                    success: function (data) { // check if available
                        if (data) { // get and check data value
                            status.text(data.progress_status); // get and print data string
                            if (data.progress_status == "SUCCESS") {
                                status.text("DONE");
                                clearInterval(pollInterval); // optional: stop poll function
                            } else if (data.progress_status == "FAILURE") {
                                status.text("ERROR");
                                clearInterval(pollInterval);
                            }

                        }
                    },
                    error: function () { // error logging
                        status.text("error polling progress data")
                    }
                });
            },
            pollInterval = setInterval(function () { // run function every 5000 ms
                poll();
            }, 5000);
        poll(); // also run function on init
    })();
</script>
{% endblock %}

