{% extends "base.html" %}

{% block title %} BLAST Project Details {% endblock %}

{% block page_title %}  {% endblock %}

{% block infoheader %} Project Details {% endblock %}
{% block header %}
{% endblock %}
{% block page_description %}
<h2> Project Details </h2>
<br>
    <h4> What to do if an error occures during Snakemake execution? </h4>
    <ul>
        <li> Monitor your current Snakemake run via Panoptes and check if the workflow has thrown an error or is still running </li>
        <li> If an error occurred during Snakemake execution you might think about deleting this project and starting a new one with different query sequences, databases or BLAST settings </li>
        <li> If your server machine lost internet connection during execution of the last Snakemake rules, just restart the execution process </li>
    </ul>

    <h4> Basic Informations </h4>
    <ul>
        <li> Click on the "Execute Snakemake" Button if you haven't started your BLAST analysis </li>
        <li> Monitor your current Snakemake run via Panoptes by clicking on the "Panoptes Monitoring" button </li>
        <li> If your Snakemake execution finishes you can view and download the results by clicking on the "Reciprocal Results Table" button which appears after successfull termination at the right side of the project information panel</li>
    </ul>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="dashboard_project_list_col">
    <h2 style="text-align: center"> BLAST Project Details and Execution Dashboard</h2>
    <p style="font-size: medium; text-align: center">
        {% if OneWayBlastProject.project_execution_task_result.status == 'SUCCESS' %}
            Your BLAST Project finished successfully, check the result table and the genus graph for evaluating your results.
        {% elif OneWayBlastProject.project_execution_task_result.status == 'FAILURE' %}
            Re-Execute your Snakemake Run for this BLAST project or delete the project.
        {% elif OneWayBlastProject.project_execution_task_result.status == 'PROGRESS' %}
            Your BLAST analysis is still in progress, monitor your current Snakemake Run via Panoptes.
        {% else %}
            Execute your BLAST project by pressing the Execute Snakemake button.
        {% endif %}
    </p>

    <br>
        <div class="table-responsive">
            <table class="table table-hover" id="blastProjectTable">
                <thead>
                    <tr>
                        <th>Project Title</th>
                        <th>Database</th>
                        <th>Timestamp</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="blastProjectTableBody">
                    <tr>
                        <td>{{OneWayBlastProject.project_title}}</td>
                        <td>
                            <table>
                                <tr>
                                    <tr> <td>Title: {{OneWayBlastProject.project_database.database_name}}</td></tr>
                                    <tr> <td>Entries: {{OneWayBlastProject.project_database.assembly_entries}}</td></tr>

                                </tr>
                            </table>
                        </td>

                        <td>{{OneWayBlastProject.timestamp |date:'d.m.Y, h:m:s' }}</td>

                        <td>
                            <form class="col"
                                   action="{% url 'one_way_project_deletion' project_id=OneWayBlastProject.id%}"
                                   method="GET">
                                {% csrf_token %}
                                <input type="submit" value="Delete Blast Project" class="btn btn-danger">
                            </form>
                        </td>
                        <td>
                            <form class="col"
                                   action="{% url 'one_way_project_execution' project_id=OneWayBlastProject.id %}"
                                   method="POST">
                                {% csrf_token %}
                                <input type="submit" value="Execute Snakemake" class="btn btn-dark">
                            </form>
                        </td>
                        {% if OneWayBlastProject.project_execution_task_result %}
                            <td><a class="btn btn-primary" href="http://127.0.0.1:5000/workflows/"> PANOPTES MONITORING </a></td>
                        {% endif %}
                        {% if OneWayBlastProject.project_execution_task_result.status == 'SUCCESS' %}
                            <td><a class="btn btn-dark" href="{% url 'one_way_html_results' project_id=OneWayBlastProject.id remote=0 %}"> Results Table </a></td>
                        {% endif %}

                        <td>
                            <a class="btn btn-dark" href="{% url 'one_way_target_sequence_download' project_id=OneWayBlastProject.id project_type='one_way_blast' filename=OneWayBlastProject.project_query_sequences %}"> Download Query Fasta Files </a>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <br>
    <!-- <div class="dashboard_project_list_col" id="QUERY_INFO">
        <h2 style="text-align: center">Query Information - NCBI query sequence information</h2>
        <p style="font-size: medium; text-align: center"> If target sequence identifier (acc #) reside in the NCBI protein database, you will see additional information.</p>

        <br>
    </div> -->


    <div class="dashboard_project_list_col">
        <h2 style="text-align: center">BLAST Database Content - Target Genomes</h2>
        <br>
        <div class="container-fluid">
            <table class="table table-hover" id="blastdatabase">
                <thead>
                 <tr>
                    <th>Index</th>
                     <th> Assembly Accession</th>
                     <th> Organism Name</th>
                     <th> Taxid </th>
                     <th> Species Taxid </th>
                     <th> Assembly Level </th>
                     <th> FTP Path </th>
                 </tr>
                </thead>
                <tbody>
                 <tr>
                 </tr>
                </tbody>
            </table>
        </div>
    </div>

    {% if OneWayBlastProject.project_execution_task_result.status == 'SUCCESS' %}
    <br>
    <div class="dashboard_project_list_col">
        <h2 style="text-align: center">Query Sequence Information</h2>
        <p style="font-size: medium; text-align: center"> This table combines information about your uploaded query sequences.
            Information is just available for valid accession ids (ids with sequences stored in the NCBI protein database). </p>
        <br>
        <div class="container-fluid">
            {{ OneWayBlastProject.read_query_information_table | safe }}
        </div>
    </div>
    <br>
    <div class="dashboard_project_list_col">
        {% include GenusPlotTemplate %}
    </div>

    {% endif %}
</div>
{% endblock %}


{% block scripts %}
<script>
$(document).ready(function() {
    $('#blastdatabase').DataTable({
        dom: 'Bfrtip',
        buttons: [
            'copy',
            'csv',
            'selectAll',
            'selectNone',
            'selectRows'
        ],
        select: true,

        "ajax": {
            "url": "{% url 'ajax_call' database_id=Database.id %}",
            "type": "GET",
            "dataSrc": "data",
        },
        "columns": [
            {"data":'index'},
            {"data":'assembly_accession'},
            {"data":'organism_name'},
            {"data":'taxid'},
            {"data":'species_taxid'},
            {"data":'assembly_level'},
            {"data":'ftp_path'}],
        "deferRender": true
        });
} );
</script>

<script>
$(document).ready(function(){
    var result_table = document.getElementById('myTable');
    result_table.setAttribute("class","display")
    $('#myTable').DataTable(
        {
            dom: 'Bfrtip',
            "lengthMenu": [ 10 ],
            buttons: [
                'copy',
                'csv',
                'selectAll',
                'selectNone',
                'selectRows'
            ],
            select: true,
            "columns":[
                {"data":"index"},
                {"data":"Accession ID"},
                {"data":"Organism"},
                {"data":"Sequence Length"},
                {"data":"Sequence Definition"},
                {"data":"Features"},
                {"data":"PFAM",fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
                        if(oData.PFAM){
                            $(nTd).html("<a href='"+oData.PFAM+"'>"+oData.PFAM+"</a>");
                        } else {
                            $(nTd).html("<p>no link available</p>");
                        }
                    }},
                {"data":"CDD",fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
                        if(oData.CDD) {
                            $(nTd).html("<a href='"+oData.CDD+"'>"+oData.CDD+"</a>");
                        } else {
                            $(nTd).html("<p>no link available</p>");
                        }
                    }
                },
                {"data":"TIGR",fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
                        if(oData.TIGR) {
                            $(nTd).html("<a href='"+oData.TIGR+"'>"+oData.TIGR+"</a>");
                        } else {
                            $(nTd).html("<p>no link available</p>");
                        }
                    }
                }
            ],
            "deferRender": true,
        }
    );

});
</script>
<!--
{% load static %}
<script src="{% static 'javascript/load_ajax_table.js' %}"></script>

<script>
    $(document).ready(function(){
            {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    var intermediate = document.getElementById('intermediate');
                    intermediate.remove();

                    var query_info = document.getElementById('QUERY_INFO');
                    var data=this.responseText;
                    var jsonResponse = JSON.parse(data);
                    var elementList =createElementListForTable(jsonResponse) //load_ajax_table.js
                    var table = buildHtmlTable(elementList); //load_ajax_table.js
                    table.className = 'table table-hover';
                    query_info.appendChild(table)
                } else if (this.readyState == 4 && this.status != 200) {
                    var intermediate = document.getElementById('intermediate')
                    intermediate.remove()

                    var query_info = document.getElementById('QUERY_INFO');
                    var error_div = document.createElement("div");
                    var error_p = document.createElement("p");
                    error_div.setAttribute("class","alert alert-warning");
                    var error_text = document.createTextNode("There is no information of your provided sequences available!")
                    error_p.appendChild(error_text)
                    error_div.appendChild(error_p)
                    query_info.appendChild(error_div)

                } else if (this.readyState == 1){
                    var info = document.getElementById('QUERY_INFO');
                    var info_div = document.createElement("div");
                    var info_p = document.createElement("p");
                    info_div.setAttribute("class","alert alert-primary");
                    info_div.setAttribute("id","intermediate")
                    var info_text = document.createTextNode("The server still processes your target sequences.")
                    info_p.appendChild(info_text)
                    info_div.appendChild(info_p)
                    info.appendChild(info_div)
                }
            };
            xhttp.open("GET", "{% url 'ajax_one_way_wp_to_links' project_id=OneWayBlastProject.id remote=0 %}", true);
            xhttp.send();
        }
    });
</script>
-->
{% endblock %}